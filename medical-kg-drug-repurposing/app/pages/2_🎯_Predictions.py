"""
Predictions Page - Browse Drug Repurposing Candidates
Explore and filter GNN predictions with validation status.
"""

import streamlit as st
import sys
from pathlib import Path
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

# Add project root to path
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

from app.utils.data_loader import (
    load_predictions,
    load_validation_results,
    load_entities
)

# Page config
st.set_page_config(page_title="Predictions", page_icon="üéØ", layout="wide")

# Header
st.title("üéØ Drug Repurposing Predictions")
st.markdown("Explore novel drug-disease predictions generated by the GNN model.")
st.markdown("---")

# Load data
predictions = load_predictions()
validation = load_validation_results()
entities = load_entities()

# Merge validation data if available
if validation is not None:
    predictions = predictions.merge(
        validation[['drug', 'disease', 'validation_status', 'pubmed_count']],
        on=['drug', 'disease'],
        how='left'
    )
    predictions['validation_status'] = predictions['validation_status'].fillna('Not Validated')
    predictions['pubmed_count'] = predictions['pubmed_count'].fillna(0).astype(int)
else:
    predictions['validation_status'] = 'Not Validated'
    predictions['pubmed_count'] = 0

# Sidebar filters
st.sidebar.markdown("## üîç Filters")

# Confidence filter
min_conf, max_conf = st.sidebar.slider(
    "Confidence Range",
    min_value=float(predictions['confidence'].min()),
    max_value=float(predictions['confidence'].max()),
    value=(float(predictions['confidence'].min()), float(predictions['confidence'].max())),
    step=0.01
)

# Validation status filter
validation_statuses = ['All'] + sorted(predictions['validation_status'].unique().tolist())
selected_status = st.sidebar.selectbox(
    "Validation Status",
    options=validation_statuses
)

# Drug search
drug_search = st.sidebar.text_input("Search Drug", "")

# Disease search
disease_search = st.sidebar.text_input("Search Disease", "")

# Apply filters
filtered_preds = predictions[
    (predictions['confidence'] >= min_conf) &
    (predictions['confidence'] <= max_conf)
]

if selected_status != 'All':
    filtered_preds = filtered_preds[filtered_preds['validation_status'] == selected_status]

if drug_search:
    filtered_preds = filtered_preds[
        filtered_preds['drug'].str.contains(drug_search, case=False, na=False)
    ]

if disease_search:
    filtered_preds = filtered_preds[
        filtered_preds['disease'].str.contains(disease_search, case=False, na=False)
    ]

# Summary metrics
st.markdown("## üìä Summary")

col1, col2, col3, col4 = st.columns(4)

with col1:
    st.metric(
        label="Total Predictions",
        value=f"{len(predictions):,}"
    )

with col2:
    st.metric(
        label="Filtered Results",
        value=f"{len(filtered_preds):,}"
    )

with col3:
    if len(filtered_preds) > 0:
        st.metric(
            label="Avg Confidence",
            value=f"{filtered_preds['confidence'].mean():.4f}"
        )
    else:
        st.metric(label="Avg Confidence", value="N/A")

with col4:
    if validation is not None and len(filtered_preds) > 0:
        novel_count = (filtered_preds['validation_status'] == 'Novel').sum()
        st.metric(
            label="Novel Predictions",
            value=f"{novel_count}",
            delta="No existing literature"
        )
    else:
        st.metric(label="Validation", value="Pending")

st.markdown("---")

# Confidence distribution
st.markdown("## üìà Confidence Distribution")

fig_dist = px.histogram(
    filtered_preds,
    x='confidence',
    nbins=50,
    title='Distribution of Prediction Confidence Scores',
    labels={'confidence': 'Confidence Score', 'count': 'Number of Predictions'},
    color_discrete_sequence=['#1f77b4']
)
fig_dist.update_layout(height=400, showlegend=False)
st.plotly_chart(fig_dist, use_container_width=True)

st.markdown("---")

# Predictions table
st.markdown(f"## üìã Predictions Table ({len(filtered_preds)} results)")

# Configure display columns
display_cols = ['rank', 'drug', 'disease', 'confidence']
if validation is not None:
    display_cols.extend(['validation_status', 'pubmed_count'])

# Display table
st.dataframe(
    filtered_preds[display_cols].style.format({
        'confidence': '{:.4f}',
        'pubmed_count': '{:,.0f}' if validation is not None else None
    }).background_gradient(subset=['confidence'], cmap='YlGnBu'),
    use_container_width=True,
    height=600
)

# Download button
csv = filtered_preds.to_csv(index=False)
st.download_button(
    label="üì• Download Filtered Predictions as CSV",
    data=csv,
    file_name="filtered_predictions.csv",
    mime="text/csv"
)

st.markdown("---")

# Top predictions highlight
if validation is not None:
    st.markdown("## üèÜ Highlighted Predictions")

    tab1, tab2, tab3 = st.tabs(["üÜï Novel", "‚úÖ Confirmed", "üî¨ Emerging"])

    with tab1:
        st.markdown("### Novel Predictions (No Existing Literature)")
        st.markdown("These represent the **highest-value** drug repurposing opportunities with no prior research.")

        novel = filtered_preds[filtered_preds['validation_status'] == 'Novel'].head(20)
        if len(novel) > 0:
            st.dataframe(
                novel[['rank', 'drug', 'disease', 'confidence']].style.format({
                    'confidence': '{:.4f}'
                }),
                use_container_width=True
            )
        else:
            st.info("No novel predictions in current filter.")

    with tab2:
        st.markdown("### Confirmed Predictions (Strong Literature Support)")
        st.markdown("These predictions have ‚â•5 PubMed articles supporting the drug-disease relationship.")

        confirmed = filtered_preds[filtered_preds['validation_status'] == 'Confirmed'].head(20)
        if len(confirmed) > 0:
            st.dataframe(
                confirmed[['rank', 'drug', 'disease', 'confidence', 'pubmed_count']].style.format({
                    'confidence': '{:.4f}',
                    'pubmed_count': '{:,.0f}'
                }),
                use_container_width=True
            )
        else:
            st.info("No confirmed predictions in current filter.")

    with tab3:
        st.markdown("### Emerging Predictions (Some Evidence)")
        st.markdown("These predictions have 1-4 PubMed articles, indicating emerging research areas.")

        emerging = filtered_preds[filtered_preds['validation_status'] == 'Emerging'].head(20)
        if len(emerging) > 0:
            st.dataframe(
                emerging[['rank', 'drug', 'disease', 'confidence', 'pubmed_count']].style.format({
                    'confidence': '{:.4f}',
                    'pubmed_count': '{:,.0f}'
                }),
                use_container_width=True
            )
        else:
            st.info("No emerging predictions in current filter.")

st.markdown("---")

# Drug and disease insights
st.markdown("## üîç Top Entities in Predictions")

col1, col2 = st.columns(2)

with col1:
    st.markdown("### Top 10 Drugs by Prediction Count")
    top_drugs = filtered_preds['drug'].value_counts().head(10)
    fig_drugs = px.bar(
        x=top_drugs.values,
        y=top_drugs.index,
        orientation='h',
        labels={'x': 'Number of Predictions', 'y': 'Drug'},
        color=top_drugs.values,
        color_continuous_scale='Blues'
    )
    fig_drugs.update_layout(showlegend=False, height=400)
    st.plotly_chart(fig_drugs, use_container_width=True)

with col2:
    st.markdown("### Top 10 Diseases by Prediction Count")
    top_diseases = filtered_preds['disease'].value_counts().head(10)
    fig_diseases = px.bar(
        x=top_diseases.values,
        y=top_diseases.index,
        orientation='h',
        labels={'x': 'Number of Predictions', 'y': 'Disease'},
        color=top_diseases.values,
        color_continuous_scale='Reds'
    )
    fig_diseases.update_layout(showlegend=False, height=400)
    st.plotly_chart(fig_diseases, use_container_width=True)

st.markdown("---")

# Recommendation tool
st.markdown("## üîé Find Recommendations")

col1, col2 = st.columns(2)

with col1:
    st.markdown("### Find Treatments for a Disease")
    disease_list = sorted(predictions['disease'].unique())
    selected_disease = st.selectbox("Select Disease", options=disease_list, key='disease_select')

    if selected_disease:
        disease_preds = predictions[predictions['disease'] == selected_disease].sort_values('confidence', ascending=False).head(10)
        st.dataframe(
            disease_preds[['rank', 'drug', 'confidence']].style.format({
                'confidence': '{:.4f}'
            }),
            use_container_width=True
        )

with col2:
    st.markdown("### Find New Uses for a Drug")
    drug_list = sorted(predictions['drug'].unique())
    selected_drug = st.selectbox("Select Drug", options=drug_list, key='drug_select')

    if selected_drug:
        drug_preds = predictions[predictions['drug'] == selected_drug].sort_values('confidence', ascending=False).head(10)
        st.dataframe(
            drug_preds[['rank', 'disease', 'confidence']].style.format({
                'confidence': '{:.4f}'
            }),
            use_container_width=True
        )
